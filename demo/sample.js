!function(e,a){"object"==typeof exports&&"object"==typeof module?module.exports=a():"function"==typeof define&&define.amd?define([],a):"object"==typeof exports?exports.goma=a():e.goma=a()}(window,function(){return function(e){var a={};function t(l){if(a[l])return a[l].exports;var n=a[l]={i:l,l:!1,exports:{}};return e[l].call(n.exports,n,n.exports,t),n.l=!0,n.exports}return t.m=e,t.c=a,t.d=function(e,a,l){t.o(e,a)||Object.defineProperty(e,a,{enumerable:!0,get:l})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,a){if(1&a&&(e=t(e)),8&a)return e;if(4&a&&"object"==typeof e&&e&&e.__esModule)return e;var l=Object.create(null);if(t.r(l),Object.defineProperty(l,"default",{enumerable:!0,value:e}),2&a&&"string"!=typeof e)for(var n in e)t.d(l,n,function(a){return e[a]}.bind(null,n));return l},t.n=function(e){var a=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(a,"a",a),a},t.o=function(e,a){return Object.prototype.hasOwnProperty.call(e,a)},t.p="",t(t.s=1)}([function(e,a,t){},function(e,a,t){"use strict";t.r(a);var l={};t.r(l),t.d(l,"ajax",function(){return i});t(0);var n={activeShape:null,labelInfo:{imagePath:null,baseName:null,imageData:null,shapes:[],imageWidth:null,imageHeight:null},currentLabel:null,isDrawing:!1,isMouseDown:!1};let i=(e,a,t)=>{let l=new XMLHttpRequest;l.responseType="json",l.onreadystatechange=()=>{200==l.status&&4==l.readyState&&t&&t(l)},a?l.open("POST",e,!0):l.open("GET",e,!0),l.send(a)},s={},r=function(e){let a=e.target;for(;this!=a;){let e=a.dataset&&a.dataset.feat;if(e)switch(e){case"getLabel":"function"==typeof s.getLabel&&s.getLabel(n.activeShape)}a=a.parentNode}},c=e=>{e.preventDefault();let a=e.dataTransfer.files[0];if(!a||-1===a.type.indexOf("image"))return;L.appEl.classList.add("GOMA_LABEL");let t=new FileReader;t.onloadend=e=>{n.labelInfo.imageData=t.result,L.statusEl.style="",L.statusEl.innerText="",b()},t.readAsDataURL(a)},o=e=>{L.statusEl.innerText="拖拽一张图片到这里"},p=e=>{e.preventDefault(),L.statusEl.innerText="可以松手了"},d=e=>{e.preventDefault();let a={x:e.offsetX,y:e.offsetY};n.isMouseDown=!0,0==e.button&&(n.isDrawing?I(a):T(a))},h=e=>{e.preventDefault();let a={x:e.offsetX,y:e.offsetY};if(n.isDrawing){var t=n.currentLabel.points;t[t.length-1]=[a.x,a.y],D()}},v=e=>{e.preventDefault(),n.isMouseDown=!0},u=e=>{e.preventDefault(),2==e.button&&M()},m=e=>{let a=e.target,t={deleteLabel:function(e,a){let t=a.parentNode,l=t.dataset.labelTimestamp;return n.labelInfo.shapes.forEach(function(e,a){e.timestamp==l&&(n.labelInfo.shapes.splice(a,1),t.parentNode.removeChild(t),D())}),L.statusEl.innerText="","stop"},selectLabel:function(e,a){W();let t=a.dataset.labelTimestamp;a.classList.add("active"),n.labelInfo.shapes.forEach(function(e,a){e.timestamp==t&&(n.activeShape=e,D())});let l=n.activeShape;L.statusEl.innerHTML=`<span>[${l.name||"未命名标记"}]  宽=${l.width}像素  高=${l.height}像素  距左=${l.left}像素  距顶=${l.top}像素  </span><a href="${l.imageData}" class="download" download="${l.name||"未命名标记"}.png">下载图片</a> <a data-feat="getLabel" href="javascript:;">获取标注数据</a>`},showInput:function(e,a){L.statusEl.innerText="";let t=window.prompt("输入标注内容：",a.innerText);if(!t)return;t=(t=t.replace(/^\s+|\s$/g,"")).replace(/</g,"&lt;");let l=a.parentNode.dataset.labelTimestamp;return n.labelInfo.shapes.forEach(function(e,n){e.timestamp==l&&(e.name=t,a.innerText=t)}),"stop"}};for(;void 0!==a;){if(!a)return;let l=a.dataset&&a.dataset.feat;if("stop"===(l&&t.hasOwnProperty(l)&&t[l](e,a)))return;a=a.parentNode}},f=e=>{var a=e.keyCode||e.which||e.charCode;81==a&&(e.preventDefault(),M()),(e.ctrlKey||e.metaKey&&90==a)&&(e.preventDefault(),S())},g=(e,a)=>{let t=new Image;t.src=e,t.onload=()=>{a&&a(t)}},b=()=>{(e=>{L.labelImagesWrapEl.innerHTML="",C(a=>{n.labelInfo.shapes=[],e&&e(a)})})(e=>{y(),E(),D(),x(e),w(),L.canvasWrapEl.classList.add("show")})},E=()=>{n.imgCtx.clearRect(0,0,L.imgCanvasEl.width,L.imgCanvasEl.height),n.labelCtx.clearRect(0,0,L.labelCanvasEl.height,L.labelCanvasEl.height)},y=e=>{let a=n.labelInfo.imageWidth,t=n.labelInfo.imageHeight,l=L.imgCanvasEl,i=L.labelCanvasEl,s=L.canvasWrapEl;l.width=i.width=a,l.height=i.height=t,l.style.width=s.style.width=i.style.width=a+"px",l.style.height=s.style.height=i.style.height=t+"px"},w=()=>{var e="";n.labelInfo.shapes.forEach(function(a,t){e+='<div data-feat="selectLabel" data-label-timestamp="'+a.timestamp+'" class="labelImage" id="label_'+a.timestamp+'"><div class="label-img-wrap"><img src="'+a.imageData+'"/></div><div class="label-name" data-feat="showInput"><span>'+(a.name||"未命名标记")+'</span></div><div data-feat="deleteLabel" class="delete-label"><svg width="14" height="14" viewBox="0 0 20 20"><path fill="#000000" d="M15.5 2h-3.5v-0.5c0-0.827-0.673-1.5-1.5-1.5h-2c-0.827 0-1.5 0.673-1.5 1.5v0.5h-3.5c-0.827 0-1.5 0.673-1.5 1.5v1c0 0.652 0.418 1.208 1 1.414v12.586c0 0.827 0.673 1.5 1.5 1.5h10c0.827 0 1.5-0.673 1.5-1.5v-12.586c0.582-0.206 1-0.762 1-1.414v-1c0-0.827-0.673-1.5-1.5-1.5zM8 1.5c0-0.276 0.224-0.5 0.5-0.5h2c0.276 0 0.5 0.224 0.5 0.5v0.5h-3v-0.5zM14.5 19h-10c-0.276 0-0.5-0.224-0.5-0.5v-12.5h11v12.5c0 0.276-0.224 0.5-0.5 0.5zM16 4.5c0 0.276-0.224 0.5-0.5 0.5h-12c-0.276 0-0.5-0.224-0.5-0.5v-1c0-0.276 0.224-0.5 0.5-0.5h12c0.276 0 0.5 0.224 0.5 0.5v1z"></path><path fill="#000000" d="M12.5 7c-0.276 0-0.5 0.224-0.5 0.5v10c0 0.276 0.224 0.5 0.5 0.5s0.5-0.224 0.5-0.5v-10c0-0.276-0.224-0.5-0.5-0.5z"></path><path fill="#000000" d="M9.5 7c-0.276 0-0.5 0.224-0.5 0.5v10c0 0.276 0.224 0.5 0.5 0.5s0.5-0.224 0.5-0.5v-10c0-0.276-0.224-0.5-0.5-0.5z"></path><path fill="#000000" d="M6.5 7c-0.276 0-0.5 0.224-0.5 0.5v10c0 0.276 0.224 0.5 0.5 0.5s0.5-0.224 0.5-0.5v-10c0-0.276-0.224-0.5-0.5-0.5z"></path></svg></div></div>'}),L.labelImagesWrapEl.innerHTML=e},x=e=>{var a=n.imgCtx;a.save(),a.clearRect(0,0,a.canvas.width,a.canvas.height),a.drawImage(e,0,0),a.restore()},C=e=>{g(n.labelInfo.imageData,a=>{setTimeout(()=>{n.labelInfo.imageWidth=a.width,n.labelInfo.imageHeight=a.height,e&&e(a)},300)})},L={},I=e=>{var a=n.currentLabel.points;2==a.length&&a[0][0]==e.x&&a[0][1]==e.y||(a[a.length-1]=[e.x,e.y],n.currentLabel.points.push([e.x,e.y]),a.length>3&&((()=>{if(!n.currentLabel)return;let e=n.currentLabel,a=e.points;if(a.length<=3)return;let t=[],l=[];a.map(function(e,a){t.push(e[0]),l.push(e[1])});let i=e.left=Math.min.apply(null,t),s=e.top=Math.min.apply(null,l),r=L.cacheCanvasEl.width=e.width=Math.max.apply(null,t)-i,c=L.cacheCanvasEl.height=e.height=Math.max.apply(null,l)-s;n.cacheCtx.clearRect(0,0,r,c);let o=n.imgCtx.getImageData(i,s,r,c);n.cacheCtx.putImageData(o,0,0),e.imageData=L.cacheCanvasEl.toDataURL()})(),D(),(e=>{if(e){var a=L.labelImagesWrapEl.querySelector("#label_"+e.timestamp);a||((a=document.createElement("div")).setAttribute("data-feat","selectLabel"),a.setAttribute("data-label-timestamp",e.timestamp),a.classList.add("labelImage"),a.setAttribute("id","label_"+e.timestamp),a.innerHTML='<div class="label-img-wrap"></div><div data-feat="showInput" class="label-name"><span>'+(e.name||"未命名标记")+'</span></div><div data-feat="deleteLabel" class="delete-label"><svg width="14" height="14" viewBox="0 0 20 20"><path fill="#000000" d="M15.5 2h-3.5v-0.5c0-0.827-0.673-1.5-1.5-1.5h-2c-0.827 0-1.5 0.673-1.5 1.5v0.5h-3.5c-0.827 0-1.5 0.673-1.5 1.5v1c0 0.652 0.418 1.208 1 1.414v12.586c0 0.827 0.673 1.5 1.5 1.5h10c0.827 0 1.5-0.673 1.5-1.5v-12.586c0.582-0.206 1-0.762 1-1.414v-1c0-0.827-0.673-1.5-1.5-1.5zM8 1.5c0-0.276 0.224-0.5 0.5-0.5h2c0.276 0 0.5 0.224 0.5 0.5v0.5h-3v-0.5zM14.5 19h-10c-0.276 0-0.5-0.224-0.5-0.5v-12.5h11v12.5c0 0.276-0.224 0.5-0.5 0.5zM16 4.5c0 0.276-0.224 0.5-0.5 0.5h-12c-0.276 0-0.5-0.224-0.5-0.5v-1c0-0.276 0.224-0.5 0.5-0.5h12c0.276 0 0.5 0.224 0.5 0.5v1z"></path><path fill="#000000" d="M12.5 7c-0.276 0-0.5 0.224-0.5 0.5v10c0 0.276 0.224 0.5 0.5 0.5s0.5-0.224 0.5-0.5v-10c0-0.276-0.224-0.5-0.5-0.5z"></path><path fill="#000000" d="M9.5 7c-0.276 0-0.5 0.224-0.5 0.5v10c0 0.276 0.224 0.5 0.5 0.5s0.5-0.224 0.5-0.5v-10c0-0.276-0.224-0.5-0.5-0.5z"></path><path fill="#000000" d="M6.5 7c-0.276 0-0.5 0.224-0.5 0.5v10c0 0.276 0.224 0.5 0.5 0.5s0.5-0.224 0.5-0.5v-10c0-0.276-0.224-0.5-0.5-0.5z"></path></svg></div>',L.labelImagesWrapEl.appendChild(a)),e.imageData&&g(e.imageData,function(t){var l=L.cacheCanvasEl,i=n.cacheCtx,s=e.points;i.save(),l.width=e.width,l.height=e.height,i.clearRect(0,0,l.width,l.height),i.beginPath();for(var r=0;r<s.length;r++){var c=s[r],o=c[0]-e.left,p=c[1]-e.top;0!=r?i.lineTo(o,p):i.moveTo(o,p)}i.closePath(),i.clip(),i.drawImage(t,0,0),i.restore();var d=l.toDataURL();(t=a.querySelector(".label-img-wrap").querySelector("img"))?a.querySelector("img").src=d:t=a.querySelector(".label-img-wrap").innerHTML='<img src="'+d+'"/>',e.imageData=d})}})(n.currentLabel)))},M=()=>{if(!n.isDrawing)return;let e=n.currentLabel,a=e.points;if(a.length<=3){n.labelInfo.shapes.splice(n.labelInfo.shapes.indexOf(e),1);let a=L.labelImagesWrapEl.querySelector("#label_"+e.timestamp);a&&a.parentNode.removeChild(a),D()}else a.splice(a.length-1,1),D();n.currentLabel=null,n.isDrawing=!1},D=()=>{let e=n.labelCtx;e.clearRect(0,0,e.canvas.width,e.canvas.height),e.save(),e.lineWidth=1,e.lineJoin="round",e.fillStyle="hsla(60, 100%, 50%, .1)",e.strokeStyle="hsla(60, 100%, 50%, 1)";let a=n.labelInfo.shapes;for(var t=0;t<a.length;t++){let s=a[t];e.save(),n.activeShape&&n.activeShape===s&&(e.lineWidth=2,e.strokeStyle="hsla(0, 100%, 60%, 1)",e.fillStyle="hsla(0, 100%, 50%, .2)");let r=s.points;e.beginPath();for(var l=0;l<r.length;l++){var i=r[l];0==l?e.moveTo(i[0],i[1]):e.lineTo(i[0],i[1])}e.closePath(),e.fill(),e.stroke(),e.restore()}e.restore()},W=()=>{n.activeShape=null;let e=L.labelImagesWrapEl.querySelector(".labelImage.active");e&&e.classList.remove("active")},T=e=>{W(),n.isDrawing=!0,n.currentLabel={left:e.x,top:e.y,width:0,height:0,timestamp:(new Date).valueOf(),points:[[e.x,e.y],[e.x,e.y]],imageData:null},n.labelInfo.shapes.push(n.currentLabel),D()},S=()=>{if(n.isDrawing){var e=n.currentLabel.points;e.length<=2||(e.splice(e.length-2,1),D())}};t.d(a,"label",function(){return P});let P=(e,a)=>((e=>{L.appEl=e,L.appEl.style="position:fixed;top:0;left:0;width:100%;height:100%;",L.statusEl=document.createElement("div"),L.statusEl.setAttribute("id","status"),L.appEl.appendChild(L.statusEl),L.statusEl.style="position:fixed;top:5%;text-align:center;left:0;width:100%;",L.statusEl.innerText="拖拽一张图片到这里",L.canvasMainEl=document.createElement("div"),L.canvasMainEl.setAttribute("id","canvasMain"),L.appEl.appendChild(L.canvasMainEl),L.canvasWrapEl=document.createElement("div"),L.canvasWrapEl.setAttribute("id","canvasWrap"),L.canvasMainEl.appendChild(L.canvasWrapEl),L.imgCanvasEl=document.createElement("canvas"),L.imgCanvasEl.setAttribute("id","imgCanvas"),L.imgCanvasEl.style.zIndex=1,n.imgCtx=L.imgCanvasEl.getContext("2d"),L.canvasWrapEl.appendChild(L.imgCanvasEl),L.labelCanvasEl=document.createElement("canvas"),L.labelCanvasEl.setAttribute("id","labelCanvas"),L.labelCanvasEl.style.zIndex=2,n.labelCtx=L.labelCanvasEl.getContext("2d"),L.canvasWrapEl.appendChild(L.labelCanvasEl),L.labelPanelEl=document.createElement("div"),L.labelPanelEl.setAttribute("id","labelPanel"),L.appEl.appendChild(L.labelPanelEl),L.labelImagesWrapEl=document.createElement("div"),L.labelImagesWrapEl.setAttribute("id","labelImagesWrap"),L.labelPanelEl.appendChild(L.labelImagesWrapEl),L.cacheCanvasEl=document.createElement("canvas"),n.cacheCtx=L.cacheCanvasEl.getContext("2d")})(e),(e=>{s=e,L.appEl.addEventListener("dragover",p),L.appEl.addEventListener("dragleave",o),L.appEl.addEventListener("drop",c),L.canvasWrapEl.addEventListener("mousedown",d),L.canvasWrapEl.addEventListener("mousemove",h),L.canvasWrapEl.addEventListener("mouseup",v),L.canvasWrapEl.addEventListener("contextmenu",u),L.labelImagesWrapEl.addEventListener("click",m),L.statusEl.addEventListener("click",r),window.addEventListener("keydown",f)})(a||{}),Object.assign({},l))}])});